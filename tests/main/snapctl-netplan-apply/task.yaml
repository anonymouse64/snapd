summary: Check that snapctl netplan-apply works with network-setup-control

# only ubuntu 18.04+ and ubuntu-core use netplan by default
systems: [ubuntu-core-*, ubuntu-18*, ubuntu-19*, ubuntu-2*]

execute: |
    # shellcheck source=tests/lib/snaps.sh
    . "$TESTSLIB/snaps.sh"

    echo "When the service snap is installed"
    install_local test-snapd-snapctl-netplan-apply

    # check that the app fails without the interface connected
    echo "running without connection of network-setup-control fails"
    if test-snapd-snapctl-netplan-apply.netplan-apply; then
      exit 1
    fi

    echo "Connecting network-setup-control"
    snap connect test-snapd-snapctl-netplan-apply:network-setup-control

    echo "Now it runs as root"
    test-snapd-snapctl-netplan-apply.netplan-apply

    echo "but it doesn't run as non-root"
    if su ubuntu -c "test-snapd-snapctl-netplan-apply.netplan-apply"; then
      exit 1
    fi
