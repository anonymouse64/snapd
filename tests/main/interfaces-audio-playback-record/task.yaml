summary: Ensure that the audio-playback/record interface works

# Only classic Ubuntu has the pulseaudio mediation patches
systems: [ubuntu-1*-*64, ubuntu-2*-*64]

environment:
    PLAY_FILE: "/snap/test-snapd-audio-record/current/usr/share/sounds/alsa/Noise.wav"
    PA_TEST_LOG: /home/test/pulseaudio.log
    # today, only 19.10 has a mediating pulseaudio
    EXFAIL: "ubuntu-1[468]"

prepare: |
    #shellcheck source=tests/lib/pkgdb.sh
    . "$TESTSLIB"/pkgdb.sh
    snap install --edge test-snapd-audio-record

    apt-get update
    apt-get install -y pulseaudio pulseaudio-utils

    echo "Create XDG_RUNTIME_DIR=/run/user/12345"
    # shellcheck disable=SC2174
    mkdir -m 700 -p /run/user/12345 || true
    chown test:test /run/user/12345

    # ensure we have a clean pulse directory
    test -d /home/test/.config && mv /home/test/.config /home/test/.config.spread
    mkdir -m 700 /home/test/.config
    mkdir -m 700 /home/test/.config/pulse
    chown test:test /home/test/.config /home/test/.config/pulse

    # prepare the script for pulseaudio daemon
    cat <<'EOF' > /home/test/pulse-test.pa
    .fail
    load-module module-null-sink sink_name=void
    set-default-sink void
    load-module module-native-protocol-unix
    .ifexists module-snap-policy.so
    load-module module-snap-policy
    .endif
    EOF
    chown test:test /home/test/pulse-test.pa
    # make sure there are no running pulseaudio processes owned by the test user
    pkill -9 --uid 12345 pulseaudio || true
    # make sure there is no socket
    rm -f /run/user/12345/pulse/native

restore: |
    HOME=/home/test XDG_RUNTIME_DIR=/run/user/12345 su -p -c "pulseaudio --kill" test || true
    snap remove --purge test-snapd-audio-record
    apt-get autoremove --purge -y pulseaudio pulseaudio-utils
    rm -rf /run/user/12345 /home/test/.config/pulse
    if [ -d /home/test/.config.spread ]; then
        rm -rf /home/test/.config
        mv /home/test/.config.spread /home/test/.config
    fi
    rm -f /home/test/pulse-test.pa
    rm -f /run/user/12345/pulse/native
    rm -f $PA_TEST_LOG

debug: |
    if [ -f $PA_TEST_LOG ]; then
        cat $PA_TEST_LOG
    fi

execute: |
    as_user() {
        su -l -c "HOME=/home/test XDG_RUNTIME_DIR=/run/user/12345 $*" test
    }

    echo "Start pulseaudio"
    as_user "pulseaudio --exit-idle-time=300 -n -F /home/test/pulse-test.pa --log-level=4 --verbose 2>&1 | tee $PA_TEST_LOG >/dev/null" &
    papid=$!

    echo "Then wait for the socket to show up"
    retry-tool -n 10 test -S /run/user/12345/pulse/native

    echo "Check pulseaudio"
    retry-tool -n 10 su -l -c "HOME=/home/test XDG_RUNTIME_DIR=/run/user/12345 pulseaudio --check" test

    echo "The unconfined user can play audio"
    as_user "PULSE_LOG=4 /usr/bin/paplay $PLAY_FILE"

    echo "The unconfined user can record audio"
    as_user "PULSE_LOG=4 /snap/test-snapd-audio-record/current/bin/parec-simple"

    echo "The audio-playback interface is connected by default"
    snap connections test-snapd-audio-record | MATCH "audio-playback +test-snapd-audio-record:audio-playback +:audio-playback +-"

    echo "The audio-record interface is disconnected by default"
    snap connections test-snapd-audio-record | MATCH "audio-record +test-snapd-audio-record:audio-record +- +-"

    echo "When the audio-playback plug is connected"
    snap connect test-snapd-audio-record:audio-playback

    echo "Then the snap can play audio"
    as_user "test-snapd-audio-record.play $PLAY_FILE"

    echo "When the audio-record plug is connected"
    snap connect test-snapd-audio-record:audio-record

    echo "Then the snap can record audio"
    as_user "test-snapd-audio-record.recsimple"

    echo "When the audio-record plug is disconnected"
    snap disconnect test-snapd-audio-record:audio-record

    mediating_pa="yes"
    if echo "$SPREAD_SYSTEM" | grep -Eq "$EXFAIL" ; then
        mediating_pa="no"
    fi

    echo "Then the snap command is not able to record audio"
    if [ "$mediating_pa" = "no" ] && ! as_user "test-snapd-audio-record.recsimple" ; then
        echo "Could not record audio. Does '$SPREAD_SYSTEM' have mediation patches?"
        exit 1
    elif [ "$mediating_pa" = "yes" ] && as_user "test-snapd-audio-record.recsimple" ; then
        echo "Could record audio even though '$SPREAD_SYSTEM' should have mediation patches"
        exit 1
    fi

    if [ "$(snap debug confinement)" = "partial" ] ; then
        exit 0
    fi

    echo "When the audio-playback plug is disconnected"
    snap disconnect test-snapd-audio-record:audio-playback

    echo "Then the snap command is not able to connect to the pulseaudio socket"
    if as_user "test-snapd-audio-record.play $PLAY_FILE" ; then
        echo "Expected error with plug disconnected"
        exit 1
    fi
